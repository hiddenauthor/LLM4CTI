{
  "relationshiplist": [
    {
      "sub": "DMA Locker",
      "rel": "moves itself into",
      "rel_type": [
        "modifies-or-removes-or-replaces"
      ],
      "obj": "C:ProgramData"
    },
    {
      "sub": "DMA Locker",
      "rel": "renamed to",
      "rel_type": [
        "other"
      ],
      "obj": "fakturax.exe"
    },
    {
      "sub": "DMA Locker",
      "rel": "drops",
      "rel_type": [
        "drops"
      ],
      "obj": "ntserver.exe"
    },
    {
      "sub": "fakturax.exe",
      "rel": "is removed after execution",
      "rel_type": [
        "modifies-or-removes-or-replaces"
      ],
      "obj": "fakturax.exe"
    },
    {
      "sub": "DMA Locker",
      "rel": "adds keys to",
      "rel_type": [
        "modifies-or-removes-or-replaces"
      ],
      "obj": "autorun"
    },
    {
      "sub": "key",
      "rel": "deploy",
      "rel_type": [
        "drops"
      ],
      "obj": "a dropped copy of the program"
    },
    {
      "sub": "key",
      "rel": "display",
      "rel_type": [
        "executes"
      ],
      "obj": "a ransom note"
    },
    {
      "sub": "Ransom.DMALocker",
      "rel": "indicates",
      "rel_type": [
        "indicates"
      ],
      "obj": "Ransom.DMALocker"
    },
    {
      "sub": "Authors of the malware",
      "rel": "mention",
      "rel_type": [
        "other"
      ],
      "obj": "AES"
    },
    {
      "sub": "Authors of the malware",
      "rel": "mention",
      "rel_type": [
        "other"
      ],
      "obj": "RSA"
    },
    {
      "sub": "DMA Locker",
      "rel": "check for the presence of",
      "rel_type": [
        "malicious-investigates-track-detects"
      ],
      "obj": "rstrui.exe"
    },
    {
      "sub": "DMA Locker",
      "rel": "check for the presence of",
      "rel_type": [
        "malicious-investigates-track-detects"
      ],
      "obj": "ShadowExplorer.exe"
    },
    {
      "sub": "DMA Locker",
      "rel": "check for the presence of",
      "rel_type": [
        "malicious-investigates-track-detects"
      ],
      "obj": "sesvc.exe"
    },
    {
      "sub": "DMA Locker",
      "rel": "check for the presence of",
      "rel_type": [
        "malicious-investigates-track-detects"
      ],
      "obj": "cbengine.exe"
    },
    {
      "sub": "encrypted files",
      "rel": "prefixed by",
      "rel_type": [
        "other"
      ],
      "obj": "ABCXYZ11"
    },
    {
      "sub": "d35344b1f48764ba083e51438121e6a9",
      "rel": "indicates",
      "rel_type": [
        "indicates"
      ],
      "obj": "DMA Locker"
    },
    {
      "sub": "4190df2af81ece296c465e245fc0caea",
      "rel": "indicates",
      "rel_type": [
        "indicates"
      ],
      "obj": "DMA Locker"
    },
    {
      "sub": "6fbd3cdcafd6695c384a1119873786aa",
      "rel": "indicates",
      "rel_type": [
        "indicates"
      ],
      "obj": "DMA Locker"
    },
    {
      "sub": "DMA Locker",
      "rel": "comes with",
      "rel_type": [
        "has"
      ],
      "obj": "a decrypting feature builtin"
    }
  ],
  "entitylist": [
    {
      "name": "DMA Locker",
      "type": "malware",
      "alias": [
        "a dropped copy of the program",
        "Ransom.DMALocker",
        "fakturax.exe",
        "ntserver.exe"
      ],
      "mother entity": [
        "None"
      ]
    },
    {
      "name": "d35344b1f48764ba083e51438121e6a9",
      "type": "indicator",
      "alias": [
        "Polish version type 2"
      ],
      "mother entity": [
        "DMA Locker"
      ]
    },
    {
      "name": "4190df2af81ece296c465e245fc0caea",
      "type": "indicator",
      "alias": [
        "English version type 2"
      ],
      "mother entity": [
        "DMA Locker"
      ]
    },
    {
      "name": "6fbd3cdcafd6695c384a1119873786aa",
      "type": "indicator",
      "alias": [
        "Polish version type 1"
      ],
      "mother entity": [
        "DMA Locker"
      ]
    },
    {
      "name": "C:ProgramData",
      "type": "file",
      "alias": [
        "C:Documents and SettingsAll UsersDokumenty"
      ],
      "mother entity": [
        "None"
      ]
    },
    {
      "name": "fakturax.exe",
      "type": "file",
      "alias": [
        "DMA Locker",
        "a dropped copy of the program",
        "Ransom.DMALocker",
        "ntserver.exe"
      ],
      "mother entity": [
        "None"
      ]
    },
    {
      "name": "ntserver.exe",
      "type": "file",
      "alias": [
        "DMA Locker",
        "a dropped copy of the program",
        "Ransom.DMALocker",
        "fakturax.exe"
      ],
      "mother entity": [
        "None"
      ]
    },
    {
      "name": "key",
      "type": "credential-value",
      "alias": [
        "None"
      ],
      "mother entity": [
        "None"
      ]
    },
    {
      "name": "autorun",
      "type": "windows-registry-key",
      "alias": [
        "None"
      ],
      "mother entity": [
        "None"
      ]
    },
    {
      "name": "Ransom.DMALocker",
      "type": "indicator",
      "alias": [
        "DMA Locker",
        "a dropped copy of the program",
        "fakturax.exe",
        "ntserver.exe"
      ],
      "mother entity": [
        "None"
      ]
    },
    {
      "name": "AES",
      "type": "abstract-concept",
      "alias": [
        "None"
      ],
      "mother entity": [
        "None"
      ]
    },
    {
      "name": "RSA",
      "type": "abstract-concept",
      "alias": [
        "None"
      ],
      "mother entity": [
        "None"
      ]
    },
    {
      "name": "rstrui.exe",
      "type": "process",
      "alias": [
        "None"
      ],
      "mother entity": [
        "None"
      ]
    },
    {
      "name": "ShadowExplorer.exe",
      "type": "process",
      "alias": [
        "None"
      ],
      "mother entity": [
        "None"
      ]
    },
    {
      "name": "sesvc.exe",
      "type": "process",
      "alias": [
        "None"
      ],
      "mother entity": [
        "None"
      ]
    },
    {
      "name": "cbengine.exe",
      "type": "process",
      "alias": [
        "None"
      ],
      "mother entity": [
        "None"
      ]
    },
    {
      "name": "ABCXYZ11",
      "type": "indicator",
      "alias": [
        "magic value"
      ],
      "mother entity": [
        "None"
      ]
    },
    {
      "name": "Authors of the malware",
      "type": "threat-actor-or-intrusion-set",
      "alias": [
        "None"
      ],
      "mother entity": [
        "None"
      ]
    },
    {
      "name": "encrypted files",
      "type": "file",
      "alias": [
        "None"
      ],
      "mother entity": [
        "None"
      ]
    },
    {
      "name": "a ransom note",
      "type": "other",
      "alias": [
        "None"
      ],
      "mother entity": [
        "None"
      ]
    },
    {
      "name": "a decrypting feature builtin",
      "type": "detailed-part-of-malware-or-hackertool",
      "alias": [
        "None"
      ],
      "mother entity": [
        "None"
      ]
    },
    {
      "name": "a dropped copy of the program",
      "type": "file",
      "alias": [
        "DMA Locker",
        "Ransom.DMALocker",
        "fakturax.exe",
        "ntserver.exe"
      ],
      "mother entity": []
    }
  ],
  "content": " DMA Locker is another ransomware that appeared at the beginning of this year. For now it has been observed to be active only on a small scale (source)  but we just want to warn you that it exists.\n[UPDATE] READ ABOUT THE LATEST VERSION OF DMA LOCKER: 4.0\n\nUPDATE [4 Feb 2016]: I apologize to everyone misguided by my rush conclusions about the crypto. After further analysis and consultation with other analysts (special thanks to fwosar and maciekkotowicz) I confirmed that in reality it is AES in ECB mode. Low entropy was just caused by the fact, that it encrypts separately 16 byte chunks, that are small enough to give this effect. Authors of the malware told many lies in their ransom note, but this one was true, just my mistake. The only way to recover the key is to find the original sample with key included. My goal is always to provide best quality analysis  this time I failed, but I tried to fix it as soon as possible and not let the false information spreading.\n\nAnalyzed samples\n\nd35344b1f48764ba083e51438121e6a9  Polish version type 2 (from Jan 2016) < main focus of this analysis\n4190df2af81ece296c465e245fc0caea  English version type 2 (from Jan 2016)\n6fbd3cdcafd6695c384a1119873786aa  Polish version type 1 (from Dec 2015)\n\n// Special thanks to malware hunters: PhysicalDrive0 , JAMESWTMHT and siriurz for their respective help in collecting the samples!\nBehavioral analysis\nWhen deployed, the ransomware moves itself into C:ProgramData (or C:Documents and SettingsAll UsersDokumenty), renamed to fakturax.exe and drops another, modified copy: ntserver.exe. File faktura.exe is removed after execution. Depending on its version, it may also drop some other files in the same location.\n\nSymptomsof this ransomware can be recognized by a red window popping up on the screen. So far, it has been observed in two language versions  Polish or English. An example of the English is below:\nEarlier version comes with a bit different GUI (also Polish or English variant):\n\nIn contrastto other ransomware that are offering a separate decrypter, DMA Locker comes with a decrypting feature builtin. It is available from the GUI with ransom note. If the user enters a key (32 characters long) in the text field and clicks the button, the program switches to the decryption mode (using supplied key):\n\nThe program is not very stable and may crash during encryption. An older version has been observed to sometimes crash after finishing encryption  but before displaying any info about what happened, which may be very confusing for the victim. What makes things worse is the fact that it does not change file extensions. So, in such a case the only visible symptom will be that the attacked person cannot open some of his/her files.\nNewer versions also addkeys to the autorun. One is to deploy a dropped copy of the program, and the other to display a ransom note in TXT format (via notepad). However, the copy of the program (DMALOCK 41:55:16:13:51:76:67:99ntserver.exe)  is not always dropped successfully and then only the TXT note may be displayed.\n\nDetection\nIt is detected by Malwarebytes AntiMalware as Ransom.DMALocker:\n\nExperiment\nIn the ransom note, the authors mention that the data is encrypted by AES and RSA. Lets look at the files.\nAfter the first look at encrypted content we can see repetitive patterns and entropy is relatively low.\nLeft  raw bytes of original BMP, right  the same BMP encrypted by DMA Locker:\n \nLets compare some more files and see how they changed after being encrypted by DMA Locker.\nExample 1  HTML files:\ncomparison of original files:\n\ncomparison of the same files encrypted:\n\nExample 2  PNG files:\ncomparison of original files:\n\ncomparison of the same files encrypted:\n\nAs we can see, when the beginnings of original files are identical, the beginnings of encrypted outputs also are. But it seems that encryption is done in some chunks  possibly 8 or 16 bytes at once. Look at the comparison of PNG files  from 0x10 they have been encrypted differently  although they both have zeros at positions 0x10, 0x11\nInside\nThis ransomware is distributed without any packingand nodefense against analysis has been observed. All the used strings and called API functions are in plain text. In fact, the malware even helps the analyst by providing a lot of debug strings describing all its activities (original  translation):\n[] Plik jest aktualnie zaszyfrowany, pomijanie.. //The file is already encrypted, skipping..\n[] Rozmiar pliku = I64d bajtow.. //File size = I64d bytes.. \n[] Rozpoczeto szyfrowanie pliku: s //Started encrypting the file: s \n[] Zakonczono szyfrowanie pliku: s //Finished encrypting the file: s\n[] Rozpoczeto zapisywanie z pamieci do pliku: s //Started dumping from memory to a file: s\n[] Zakonczono zapisywanie z pamieci do pliku: s //Finished dumping from memory to a file: s\n[] Plik jest aktualnie odszyfrowany, pomijanie.. //The file is already decrypted, skipping..\n[] Rozpoczeto deszyfrowanie pliku: s //Started decrypting file: s\n[] Zakonczono deszyfrowanie pliku: s //Finished decrypting file: s\nAlokacja, error: d //Allocation error: d\nDMA Locker\nOtwieranie pliku: d //Opening file: d\n\nThanks to the logs, finding important part of the code is trivial!\nAt the beginning of the execution a new thread is deployed  whose role is to check for the presence of following processes:\n\nrstrui.exe\nShadowExplorer.exe\nsesvc.exe\ncbengine.exe\n\nIf any of them is detected, malware tries to terminate it. Just after deploying this thread malware logs (in Polish):\n[] Blocking processes of system recovery\n\nInstead of a list of attacked extensions, this malware contains two blacklists. One for directories:\n\nand another for file extensions:\n\nFiles that contain in their path blacklisted substrings are skipped.\nMalware enumerates all the files  browsing first logical drives, after that network resources  trying to encrypt each and every file (except the blacklisted)\n\nA single flag decides whether the malware is in encryption or decryption mode:\n\nEncryption (as well as decryption) is deployed in a new thread:\nEncryption key\nThe encryption key is 32 byte long. In newer version of the malware it is hardcoded at the end of the original file, and then read. However, there is a twist.\nDuring execution, two copies of the original file are dropped: fakturax.exe and ntserver.exe  but only fakturax.exe contains the key  ntserver.exe have it cleaned. After reading the key, fakturax.exe is removed and the key is lost along with it. Thats why, we can easily recover the key if, by any means, we managed to persist the original copy of the malware sample (it is not a problem if we know the source of infection, i.e in case if the malware arrived as an email attachment).\nIn the examined variant of the malware (referred as the type 2, i.e 4190df2af81ece296c465e245fc0caea)  it was enough to find the key at the end of the original sample (WARNING: this is not the original key of this sample. It has been used just to present how it works and where the real key can be found. Before trying to recover files, make sure that you made their backup, just in case if in some other editions the algorithm would be different.)\n\nand enter it to the text field:\n\nin order to get all the files back.\nEncryption algorithm\n\nAuthors claimed that they used AES and RSA. How it looks from the side of code?\nFile is encrypted chunk by chunk  single unit have 16 bytes (4 DWORDs). The key is 32 bytes long, and is preprocessed before the encryption. Both elements  the preprocessed key and a chunk of the input file  are copied to a buffer, that is supplied to the encrypting procedure.\nBelow  a sample file: square.png processed by the encrypting function. Used key: 11111. (The copied chunk of the file has been selected on the picture)\n\nafter encryption (output marked gray):\n\noutput is then copied back to the original buffer, containing the full file. Every encrypted file has a content prefixed by ABCXYZ11  a magic value, used by the ransomware to recognize encrypted files (it has been introduced in the newer version). Below, we can see the sample file after being dumped on the disk.\n\n16 byte long chunks of file are encrypted by AES in ECB mode.\nConclusion\nFirst of all, not all what malware authors tell is true. In this case the key was neither RSA encrypted, nor randomly generated  just stored in the original file.\nSecond  immediately removing the malware is not always the best solution  sometimes we may need it to recover the data.\nIf you encountered a ransomware, it is better to try to gather information about it before taking any steps. In case you cannot find any information, the best way is to make a topic on the forum of your favorite vendor or contact some known analyst. We are in a constant search of samples of new threats, trying to describe and solve the problems.\nAnd remember: only some families are really nasty. Other, like i.e LeChiffre have implementation flaws allowing to recover files.\nAppendix\nhttps://forum.4programmers.net/HardwareSoftware/264028dmalockerzaszyfrowanepliki  a thread on a Polish forum, created by a user infected by DMA Locker\n",
  "idorurl": "60k_0015852"
}